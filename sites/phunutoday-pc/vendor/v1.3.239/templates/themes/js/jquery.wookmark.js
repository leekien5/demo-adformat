(function(n){"function"===typeof define&&define.amd?define(["window","document"],n):n(window,document)})(function(n,E){function h(a,b){return function(){return a.apply(b,arguments)}}function x(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])}function y(a,b){z(function(){var c;for(c=0;c<a.length;c++){var d=a[c];x(d.el,d.css)}"function"===typeof b&&z(b)})}function p(a){return a.replace(/^\s+|\s+$/g,"").toLowerCase()}function v(a,b,c){n.jQuery?$(a).off(b,c):a.removeEventListener?a.removeEventListener(b,c):a.detachEvent("on"+b,c)}function A(a,b,c){v(a,b,c);if(n.jQuery)$(a).on(b,c);else a.addEventListener?a.addEventListener(b,c):a.attachEvent("on"+b,function(){c.call(a)})}function B(a,b){return a.classList?a.classList.contains(b):(new RegExp("(^| )"+b+"( |$)","gi")).test(a.className)}function C(a,b){a.classList?a.classList.add(b):a.className+=" "+b}function q(a,b,c,d){void 0===d&&(d="wookmark-");a=a.getAttribute("data-"+d+b);return!0===c?parseInt(a,10):a}function r(a,b,c,d){void 0===d&&(d="wookmark-");a.setAttribute("data-"+d+b,c)}function D(a,b){return void 0!==n.getComputedStyle?n.getComputedStyle(a,null).getPropertyValue(b):a.currentStyle[b]}function k(a,b){b=b||{};"string"===typeof a&&(a=E.querySelector(a));this.container=a;this.columns=this.resizeTimer=null;this.activeItemCount=0;this.placeholders=[];this.itemHeightsDirty=this.itemHeightsInitialized=!1;this.elementTag="div";this.initItems=h(this.initItems,this);this.updateOptions=h(this.updateOptions,this);this.onResize=h(this.onResize,this);this.onRefresh=h(this.onRefresh,this);this.getItemWidth=h(this.getItemWidth,this);this.layout=h(this.layout,this);this.layoutFull=h(this.layoutFull,this);this.layoutColumns=h(this.layoutColumns,this);this.filter=h(this.filter,this);this.clear=h(this.clear,this);this.getActiveItems=h(this.getActiveItems,this);this.refreshPlaceholders=h(this.refreshPlaceholders,this);this.sortElements=h(this.sortElements,this);this.updateFilterClasses=h(this.updateFilterClasses,this);this.initItems();this.container.style.display="block";this.updateOptions(b);this.updateFilterClasses();this.autoResize&&A(n,"resize",this.onResize);A(this.container,"refreshWookmark",this.onRefresh)}var w={align:"center",autoResize:!0,comparator:null,direction:void 0,ignoreInactiveItems:!0,inactiveClass:"wookmark-inactive",itemSelector:void 0,itemWidth:0,fillEmptySpace:!1,flexibleWidth:0,offset:5,outerOffset:0,onLayoutChanged:void 0,placeholderClass:"wookmark-placeholder",possibleFilters:[],resizeDelay:50,verticalOffset:void 0},z=n.requestAnimationFrame||function(a){a()};k.prototype.initItems=function(){if(void 0===this.itemSelector){for(var a=[],b,c=this.container.children,d=c.length;d--;)b=c[d],8!==b.nodeType&&(b.style.display="",r(b,"id",d),a.unshift(b));this.items=a}else this.items=this.container.querySelectorAll(this.itemSelector);this.items.length&&(this.elementTag=this.items[0].tagName);this.itemHeightsDirty=!0};k.prototype.updateFilterClasses=function(){for(var a=this.items.length,b,c={},d,f,e,m=this.possibleFilters,g=m.length;a--;)if(f=this.items[a],(d=JSON.parse(q(f,"filter-class",!1,"")))&&"object"===typeof d)for(b=d.length;b--;)e=p(d[b]),c.hasOwnProperty(e)||(c[e]=[]),c[e].push(f);for(;g--;)a=p(m[g]),c.hasOwnProperty(a)||(c[a]=[]);this.filterClasses=c};k.prototype.updateOptions=function(a){var b;this.itemHeightsDirty=!0;a=a||{};for(b in w)w.hasOwnProperty(b)&&(a.hasOwnProperty(b)?this[b]=a[b]:this.hasOwnProperty(b)||(this[b]=w[b]));this.verticalOffset=this.verticalOffset||this.offset;this.layout(!0)};k.prototype.onResize=function(){clearTimeout(this.resizeTimer);this.itemHeightsDirty=0!==this.flexibleWidth;this.resizeTimer=setTimeout(this.layout,this.resizeDelay)};k.prototype.onRefresh=function(){this.itemHeightsDirty=!0;this.layout()};k.prototype.filter=function(a,b,c){var d=[],f=[],e;a=a||[];b=b||"or";c=c||!1;if(a.length){for(e=0;e<a.length;e++){var m=p(a[e]);this.filterClasses.hasOwnProperty(m)&&d.push(this.filterClasses[m])}e=a=d.length;if("or"===b||1===a)for(;e--;)f=f.concat(d[e]);else if("and"===b){for(var g=d[0],l,t,k,h;e--;)d[e].length<g.length&&(g=d[e]);g=g||[];for(e=g.length;e--;){k=g[e];b=a;for(l=!0;b--&&l;)if(h=d[b],g!==h){t=!1;for(m=h.length;m--&&!t;)t=h[m]===k;l&=t}l&&(f=f.concat(g[e]))}}if(1<a){e={};d=[];for(b=f.length;b--;)a=q(f[b],"id",!0),e.hasOwnProperty(a)||(e[a]=1,d.push(f[b]));f=d}if(!c)for(e=this.items.length;e--;){a:{a=f.length;for(d=0;d<a;d++)if(f[d]===this.items[e])break a;d=-1}-1===d&&C(this.items[e],this.inactiveClass)}}else f=this.items;if(!c){for(e=f.length;e--;)c=f[e],d=this.inactiveClass,c.classList?c.classList.remove(d):c.className=c.className.replace(new RegExp("(^|\\b)"+d.split(" ").join("|")+"(\\b|$)","gi")," ");this.columns=null;this.layout()}return f};k.prototype.refreshPlaceholders=function(a,b){var c,d=this.container.offsetHeight,f=this.columns.length;var e="";if(this.placeholders.length<f){for(c=0;c<f-this.placeholders.length;c++)e+="<"+this.elementTag+' class="'+this.placeholderClass+'"/>';this.container.insertAdjacentHTML("beforeend",e);this.placeholders=this.container.querySelectorAll("."+this.placeholderClass)}e=this.offset+2*parseInt(D(this.placeholders[0],"border-left-width"),10)||0;e+=2*parseInt(D(this.placeholders[0],"padding-left"),10)||0;for(c=0;c<this.placeholders.length;c++){var m=this.placeholders[c];var g=this.columns[c];if(c>=f||0===g.length)m.style.display="none";else{g=g[g.length-1];var l=q(g,"top",!0)+q(g,"height",!0)+this.verticalOffset;g=Math.max(0,d-l-e);x(m,{position:"absolute",display:0<g?"block":"none",left:c*a+b+"px",top:l+"px",width:a-e+"px",height:g+"px"})}}};k.prototype.getActiveItems=function(){var a=this.inactiveClass,b,c=[],d=this.items;if(this.ignoreInactiveItems)for(b=0;b<d.length;b++){var f=d[b];B(f,a)||c.push(f)}else return d;return c};k.prototype.getItemWidth=function(){var a=this.itemWidth,b=this.container.offsetWidth-2*this.outerOffset,c=this.flexibleWidth;"function"===typeof a&&(a=this.itemWidth());0<this.items.length&&(void 0===a||0===a&&!this.flexibleWidth)?a=this.items[0].offsetWidth:"string"===typeof a&&0<=a.indexOf("%")&&(a=parseFloat(a)/100*b);if(c){"function"===typeof c&&(c=c());"string"===typeof c&&0<=c.indexOf("%")&&(c=parseFloat(c)/100*b);var d=b+this.offset,d=Math.max(Math.floor(.5+d/(c+this.offset)),Math.floor(d/(a+this.offset))),a=Math.max(a,Math.min(c,Math.floor((b-(d-1)*this.offset)/d)))}return a};k.prototype.layout=function(a,b){if(a||null!==this.container.offsetParent){var c=this.getItemWidth(),d=c+this.offset,f=this.container.offsetWidth-2*this.outerOffset,e=Math.floor((f+this.offset)/d),m=this.getActiveItems(),g=m.length;if(a||this.itemHeightsDirty||!this.itemHeightsInitialized){for(var l=0;l<g;l++){var h=m[l];this.flexibleWidth&&(h.style.width=c+"px");r(h,"height",h.offsetHeight)}this.itemHeightsDirty=!1;this.itemHeightsInitialized=!0}e=Math.max(1,Math.min(e,g));c=this.outerOffset;"center"===this.align&&(c+=Math.floor(.5+(f-(e*d-this.offset))>>1));this.direction=this.direction||("right"===this.align?"right":"left");f=a||null===this.columns||this.columns.length!==e||this.activeItemCount!==g?this.layoutFull(d,e,c):this.layoutColumns(d,c);this.activeItemCount=g;this.container.style.height=f+"px";this.fillEmptySpace&&this.refreshPlaceholders(d,c);if(void 0!==this.onLayoutChanged&&"function"===typeof this.onLayoutChanged)this.onLayoutChanged();"function"===typeof b&&b()}};k.prototype.sortElements=function(a){return"function"===typeof this.comparator?a.sort(this.comparator):a};k.prototype.layoutFull=function(a,b,c){var d=0,f=0,e,m=null,g=null,l=[],h=[],k="left"===this.align,n=this;this.columns=[];var p=this.sortElements(this.getActiveItems());for(e=p.length;l.length<b;)l.push(this.outerOffset),this.columns.push([]);for(;f<e;){var u=p[f];m=l[0];for(d=g=0;d<b;d++)l[d]<m&&(m=l[d],g=d);r(u,"top",m);d=c;if(0<g||!k)d+=g*a;h[f]={el:u,css:{position:"absolute",top:m+"px"}};h[f].css[this.direction]=d+"px";l[g]+=q(u,"height",!0)+this.verticalOffset;this.columns[g].push(u);f++}y(h,function(){B(n.container,"wookmark-initialised")||C(n.container,"wookmark-initialised")});return Math.max.apply(Math,l)};k.prototype.layoutColumns=function(a,b){for(var c=[],d=[],f,e=0,h=this.columns.length,g,l,k,n;h--;){g=this.outerOffset;c.push(g);l=this.columns[h];n=h*a+b;for(f=0;f<l.length;f++,e++)k=l[f],r(k,"top",g),d[e]={el:k,css:{top:g+"px"}},d[e].css[this.direction]=n+"px",g+=q(k,"height",!0)+this.verticalOffset;c[h]=g}y(d);return Math.max.apply(Math,c)};k.prototype.clear=function(){clearTimeout(this.resizeTimer);for(var a=this.placeholders.length;a--;)this.container.removeChild(this.placeholders[a]);v(n,"resize",this.onResize);v(this.container,"refreshWookmark",this.onRefresh)};void 0!==n.jQuery&&(jQuery.fn.wookmark=function(a){var b=this.length;void 0!==a&&a.container instanceof jQuery&&(a.container=a.container[0]);if(1<b)for(;b--;)$(this).eq(b).wookmark(a);else 1===b&&(this.wookmarkInstance?this.wookmarkInstance.updateOptions(a||{}):this.wookmarkInstance=new k(this[0],a||{}));return this});return n.Wookmark=k});